
# Container

Класс `Container` представляет собой контейнер для управления устройствами, их соединениями и взаимодействием в рамках сервиса.

Контейнер создается внутри класса `MainProcess`. Это сделано для удобного правильного инциализирования классов `Bootstrap` и `Container` которые содержат ссылки внутри себя на друг друга.

Это центральный компонент, который:

- Инициализирует устройства согласно объекту сервиса (обычно получается из файла сервиса)
- Устанавливает соединения между портами устройств
- Управляет жизненным циклом устройств
- Обрабатывает действия и метрики устройств
- Предоставляет структуру сервиса

Контейнер наследуется от `EventEmitter` и эмитирует различные события на разных этапах работы.

Функционал контейнера может расширяться с помощью [bootstrap классов](./Bootstrap.md). Он обязательно требует реализцию всех базовых bootstrap классов. Например `DeviceManager` предоставляет контейнеру возможность загружать классы устройств и инициализировать их, только с помощью него он знает что-то о наличии устройств.

### Конструктор
```typescript
constructor(id: string, service: IServiceStructure, Bootstrap: Bootstrap, confFile?: string)
```
- `id` - уникальный ID сервиса
- `service` - структура сервиса
- `Bootstrap` - класс Bootstrap для контейнера
- `confFile` - (опционально) путь к файлу конфигурации

### init()
Инициализирует контейнер:
1. Загружает дополнительные конфигурации (если указаны)
2. Инициализирует устройства
3. Устанавливает соединения между устройствами

### run()
Запускает контейнер:
1. Запускает процессы устройств

## Обработка ошибок
Контейнер определяет множество ошибок через ErrorManager:

### Ошибки устройств:
- `CTR_ERROR_INIT_DEVICE` - ошибка инициализации устройства (общая ошибка инициализации устройства. См. Вложенные ошибки)
- `CTR_INCORRECT_DEVICE_ID` - некорректный ID устройства 
- `CTR_DEVICE_DUBLICATE` - дублирование ID устройства
- `CTR_ERROR_PREPARE_OPTIONS` - ошибка подготовки параметров
- `CTR_DEVICE_ACTION_NF` - действие устройства не найдено
- `CTR_DEVICE_NF` - устройство не найдено
- `CTR_DEVICE_ACTION_HANDLER_NF` - обработчик действия не найден
- `CTR_DEVICE_PROCESS_EXCEPTION` - исключение при выполнении process
- `CTR_DEVICE_PROCESS_PROMISE_EXCEPTION` - исключение при выполнении processPromise

### Ошибки портов:
- `CTR_INCORRECT_DYNAMIC_PN` - некорректное имя динамического порта
- `CTR_INCORRECT_PN` - некорректное имя порта
- `CTR_INPUT_HANDLER_NF` - обработчик входа не найден
- `CTR_DEVICE_PORT_NF` - порт на устройстве не найден

### Ошибки соединений:
- `CTR_CONNECTION_INCORRECT` - некорректный формат соединения
- `CTR_CONNECTION_DEVICE_NF` - устройство соединения не найдено
- `CTR_CONNECTION_PORT_NF` - порт соединения не найден
- `CTR_INCOMPATIBLE_PORTS` - несовместимые порты


## Внутренние события

События указаны в порядке их запуска. Bootstrap классы могут подписываться на событий контейнера что бы расширять его возможности. Так делают часть стандартных bootstrap классов.

 1. **configure** - Запускается первым, перед заполнением файла конфигурации
 2. **beforeInit** - Перед началом инициализации
 3. **init** - Начало инициализации устройств
 4. **initDevice(device)** - Будет выполнятся для каждого инициализируемого устройства
 5. **afterInit** - После окончания инициализации устройств
 6. **beforeConnections** - Перед началом инциализации соединений
 7. **connections** - Начало инициализации соединений
 8. **connection(conn)** - Будет выполнено для каждого соединения
 9. **afterConnections** - После окончания инциализаций соеднинений
 10. **beforeProcess** - Перед выполнением `process` для каждого устройства
 11. **process(DeviceID)** - Будет выполнено для каждого устройства перед запуском `process`
 12. **afterProcess** - После окончания всех запусков `process`
 13. **beforeProcessPromise** - Перед выполнением `processPromise` каждого устройства
 14. **processPromise(DeviceID)** -  Будет выполнено для каждого устройства перед запуском `processPromise`
 15. **afterProcessPromise** - После окончания всех запусков `processPromise`
 16. **beforeLoaded** - Перед окончанием загрузки контейнера
 17. **loaded** - После окончания загрузки контейнера


Описания структур передаваемых в указаных выше события

### initDevice(device)

Объект в виде структуры `IStructureDevice`

```ts
export default interface IStructureDevice {
    /** Device ID */
    id: string;
    /** Device type in VRack style like a 'vendor.Device' */
    type: string;
    /** Device options */
    options: { [key: string]: any; };
    /** Device connections */
    connections?: Array<string>
}
```


### connection(сс)

Объект в виде структуры: 

```ts
interface: {
    outputDevice: string;
    outputPort: string;
    inputDevice: string;
    inputPort: string;
} 
```

### process(DeviceID) & processPromise(DeviceID)

**DeviceID** - Строковый уникальный идентификатор устройсва. Доступ к любому устройсту внутри контейнера можно получить так `ContainerClass.devices[DeviceID]` или внутри устройства `this.Container.devices[DeviceID]`
