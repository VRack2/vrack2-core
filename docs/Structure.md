
# Структура приложения

## 1. Базовые требования для запуска

Минимальный набор для запуска сервиса:
- [Файл запуска](#2-файл-запуска)
- [Файловая структура](#3-файловая-структура)
- [Файл сервиса](#4-файл-сервиса)


## 2. Файл запуска

Репозиторий VRack2 является минимально настроенной готовой структурой для запуска сервиса на VRack2 Core. В VRack2 есть возможность запустить любой файл сервиса указав его после команды запуска:

Пример команды для запуска вашего файла сервиса:

```bash
npm run start "./devices/youvendor/service.json"
```

Таким образом можно запустить ваш файл сервиса без запуска VRack2. Вы можете сами написать или скопировать файл запуска из VRack2, но в таком случае вам  необходимо будет создать нужные папки и правильно указать параметры запуска сервиса в package.json. 

Рекомендуется ознакомится с оригинальным файлом запуска. Он позволяет не только запускать любой файл сервиса, но и так же запускать воркеры которые являются так же сервисами VRack2 Core.

Ниже приведена упращенная **последовательность выполнения:**

 1. Получение/формирование файла структуры сервиса
 2. Инициализация класса `MainProcess` - Упращает последовательность инициализации классов `Container` и `Bootstrap`. Это очень важно, потому что там используется сложная последовательность и линковка между друг другом. 
 3. Инициализаця класса `Container` - Будет вмещать в себя все устройства/связи создавая их по списку файла структуры,  а так же принимать все события внутри устройств
 4. Запуск `MainProcess.run()`
 5. Загрузка и запуск `Bootstrap` классов (это вспомогательные классы которые расширяют возможности устройств сервиса)
    1. `DeviceManager` - Класс работы с устройствами (группы/устройства/инициализация/информация)
    2. `DeviceStorage` - Класс обеспечивает сохрание и восстановление личных данных компонента (устройства)
    3. `StructureStorage` - Класс для работы со структурой сервиса
    4. `DeviceMetrics` - Класс для приема и обработки метрик устройств
 6. Запуск сервиса `Container.init()`
    1. Инициализация устройств
    2. Добавление соединений
    3. Запуск процессов устройств


## 3. Файловая структура

Общая структура файлов проекта выглядит так:

```
devices/            # ! Необходимо создать (директория вендоров устройств)
   {vendor}/        # Директория вендора (например, "vrack2")
      {Device}      # Файл устройства (например, "Master")
      list.json     # Файл регистрации устройств
storage/            # ! Необходимо создать (файлы хранилища устройств)
   {ContainerID}/   # Идентификатор контейнера (создается автоматически)
      {DeviceName}  # Файл данных устройства (формат: JSON) (создается при сохранении данных внутри устройства)
structure/          # ! Необходимо создать (файлы структур контейнеров)
  {ContainerID}     # Файл структуры (формат: JSON) (создается автоматически)
```

### Организация устройств  

Устройства располагаются в иерархии вендоров внутри директории `devices/`. Каждый вендор представляет собой отдельный модуль (возможно, отдельный репозиторий), что обеспечивает:  

- Четкое разделение зависимостей между вендорами  
- Независимую версию и обновление компонентов  
- Возможность включать в состав вендора дополнительные файлы (конфигурации, package.json и т.д.)  

**Структура пути к устройству:**  
```
devices/
   {vendor}/       # Директория вендора (например, "vrack2")
      {Device}      # Файл устройства (например, "Master")
      list.json     # Файл регистрации устройств
```

#### Регистрация устройств  

Для подключения устройств к системе необходимо зарегистрировать их в файле `list.json`. Поддерживается два формата:  

1. **Простой массив** (для устройств в корне вендора):  
```json
["Device1", "Device2"]
```

2. **Объект с путями** (для сложной структуры, как в VRack2):  
```json
{
  "Master": "devices/Master",
  "Interval": "devices/Interval",
  "System": "devices/System"
}
```

**Важно:**  
- Имена устройств всегда пишутся с заглавной буквы (прим. DeviceName)  
- Пути указываются относительно директории вендора  

#### Пример из VRack2  

В VRack2 устройства пишуться на TypeScript и являются отдельным репозиторием. Поэтому исходные тексты лежать в директории `devices/vrack2/src` которые  компилируются в JavaScript в директорию `devices/vrack2/devices`.
  
```
devices/
  vrack2/
    devices/       # Основная директория устройств
      Master       # Пример устройства
      System
    list.json      # Содержит mapping устройств
```

### Хранилище устройств

Устройства могут сохранять свое состояние в персистентное хранилище. Данные автоматически восстанавливаются при запуске устройства. 

**Требования:**
- Директория `storage/` должна быть создана вручную
- Поддиректории и файлы создаются автоматически при сохранении данных

**Структура хранилища:**
```
storage/
  {ContainerID}/  # Идентификатор контейнера (создается автоматически)
    {DeviceName}  # Файл данных устройства (формат: JSON)
```

### Хранилище структур контейнеров

При загрузке контейнера - `StructureStorage`  автоматически сохраняет полную структурную информацию которая формируется в контейнере.

**Структура содержит:**
 - Полную информацию о самом устройстве без его конфигурации из файла сервиса
 - Все соединения
 - Визуальные параметры (цвета, расположение)

**Требования:**
- Директория `structure/` создается вручную
- Файлы обновляются автоматически при изменениях

**Расположение файлов:**
```
structure/
  {ContainerID}  # Файл структуры (формат: JSON)
```

## 4. Файл сервиса

Файл сервсиа лучше всего расположить внутри вашего основного репозитория с устройствами. В VRack2 так и сделано - файл сервиса расположен в репозитории устройств VRack2 `devices/vrack2/service.json`.

Таким образом можно использовать один и тот же файл запуска для разных сервисов, в том числе и совместно с VRack2 без использования VRack2.